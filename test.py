
import asyncio
import json
import logging
import threading
import time
from enum import Enum
from typing import Dict, Any

# VK imports
import vk_api  # type: ignore
# Telegram imports
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton, \
    InputMediaPhoto  # type: ignore
from telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, CallbackQueryHandler, MessageHandler, \
    filters  # type: ignore
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType  # type: ignore
import requests  # type: ignore

TELEGRAM_TOKEN = "7912680613:AAH_7SLbjywJk2fqLIes9JTfrv940kHGnCE"
VK_TOKEN = "vk1.a.Zpg9wzHaNYM4K0-F3KvYs2ValUpkHXkkU0ClznSTRt_9C5Lbvi36nYiaPz41e7eVyndY0fSbvYDPfZbvp1P_VYC4PlrBrnfGQ1IAJdb4aJhZMB8odobM4BZQgOqfZUybdJR-g_FWg2tLJBkpq4YKchVevXgcU90-9SZxqVmufumLmnZB-RNe3eoiifZNRPqba_cUa76fk-3d0fy1zj3daA"
VK_GROUP_ID = "233147090"
# URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
WELCOME_PHOTOS = [
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-58%20(2).jpg",
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-58%20(3).jpg",
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-58%20(4).jpg",
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-58%20(5).jpg",
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-58%20(6).jpg",
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-58%20(7).jpg",
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-58.jpg",
    "https://raw.githubusercontent.com/tigran420/dermo/5be79081c7a6fa620a49671bf22703d98c6d9020/photo_2025-10-05_16-08-59.jpg",
    # user provided 9th maybe duplicate; keep it if exists
]
MATERIAL_PHOTOS = {
    "–ª–¥—Å–ø": "https://raw.githubusercontent.com/tigran420/dermo/refs/heads/main/photo_2025-10-06_15-58-59%20(2).jpg",
    "–∞–≥—Ç": "https://raw.githubusercontent.com/tigran420/dermo/refs/heads/main/photo_2025-10-06_15-58-59.jpg",
    "—ç–º–∞–ª—å": "https://raw.githubusercontent.com/tigran420/dermo/refs/heads/main/photo_2025-10-06_15-58-59%20(3).jpg"
}


# –í —Ñ—É–Ω–∫—Ü–∏–∏ send_telegram_application –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ TELEGRAM_TOKEN –≤–º–µ—Å—Ç–æ TELEGRAM_BOT_TOKEN
def send_telegram_application(application_data):
    if not TELEGRAM_TOKEN:
        logging.warning("Telegram bot token or chat ID not configured. Skipping sending application to Telegram group.")
        return

    message_text = "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞:\n\n"
    for key, value in application_data.items():
        message_text += f"{key}: {value}\n"

    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {
        "text": message_text,
        "parse_mode": "HTML"
    }
    try:
        response = requests.post(url, json=payload)
        response.raise_for_status()  # Raise an exception for HTTP errors
        logging.info(f"Application successfully sent to Telegram group: {response.json()}")
    except requests.exceptions.RequestException as e:
        logging.error(f"Failed to send application to Telegram group: {e}")


from vk_api.utils import get_random_id  # type: ignore

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


class Platform(Enum):
    TELEGRAM = "telegram"
    VK = "vk"


# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
WELCOME_MESSAGE = (
    "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º!ü§ù\n"
    "–ù–∞ —Å–≤—è–∑–∏ 2–ú –§–ê–ë–†–ò–ö–ê –ú–ï–ë–ï–õ–ò!\n"
    "–ú—ã –∏–∑–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–ø—É—Å–Ω—É—é –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –º–µ–±–µ–ª—å —Å 1993 –≥–æ–¥–∞, –ø–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–∞–º:\n"
    "–∫—É—Ö–Ω–∏, —à–∫–∞—Ñ—ã-–∫—É–ø–µ, –≥–∞—Ä–¥–µ—Ä–æ–±–Ω—ã–µ, –º–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.\n"
    "–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–æ–≤, –¥–µ–ª–∞–µ–º –≤—Å–µ —Å–∞–º–∏ –æ—Ç –∑–∞–º–µ—Ä–∞ –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏.\n"
    "–®–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±–æ–ª–µ–µ 1000 —Ä–∞—Å—Ü–≤–µ—Ç–æ–∫, –æ—Ç –õ–î–°–ü –¥–æ –≠–º–∞–ª–∏ –∏ —Ñ—É—Ä–Ω–∏—Ç—É—Ä—ã (Blum, Hettich, Boyard –∏ –¥—Ä.).\n"
    "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–º–µ—Ä, –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É.\n"
    "–ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ù–ï –ë–ï–†–Å–ú –ø–ª–∞—Ç—ã –∑–∞ –≤—ã—Ä–µ–∑—ã: –ø–æ–¥ –≤–∞—Ä–æ—á–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å, –ø–æ–¥ —Å–∞–Ω —É–∑–ª—ã, –ø–æ–¥ –ø–ª–∏–Ω—Ç—É—Å–∞, –ø–æ–¥ –º–æ–π–∫—É –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞—é—Ç –¥—Ä—É–≥–∏–µ –º–µ–±–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏.\n"
    "–ì–∞—Ä–∞–Ω—Ç–∏—è 24 –º–µ—Å—è—Ü–∞ –Ω–∞ –≤—Å—é –ø—Ä–æ–¥—É–∫—Ü–∏—é!\n"
    "–¶–µ–Ω—ã –ø—Ä–∏—è—Ç–Ω–æ —É–¥–∏–≤—è—Ç!\n"
    "–†–∞—Å—Å—Ä–æ—á–∫–∞!!!"
)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_data = {}


# –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏
class KeyboardManager:
    @staticmethod
    def get_initial_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–ö—É—Ö–Ω—è", callback_data="–∫—É—Ö–Ω—è")],
                [InlineKeyboardButton("–®–∫–∞—Ñ", callback_data="—à–∫–∞—Ñ")],
                [InlineKeyboardButton("–ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è", callback_data="–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è")],
                [InlineKeyboardButton("–ü—Ä–∏—Ö–æ–∂–∞—è", callback_data="–ø—Ä–∏—Ö–æ–∂–∞—è")],
                [InlineKeyboardButton("–ú–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π", callback_data="–≤–∞–Ω–Ω–∞—è")],
                [InlineKeyboardButton("–î—Ä—É–≥–∞—è –º–µ–±–µ–ª—å", callback_data="–¥—Ä—É–≥–æ–µ")],
                [InlineKeyboardButton("–°–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π", callback_data="—Å–≤—è–∑–∞—Ç—å—Å—è_—Å–æ_–º–Ω–æ–π")]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üç≥ –ö—É—Ö–Ω—è",
                                "payload": "{\"command\": \"–∫—É—Ö–Ω—è\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üö™ –®–∫–∞—Ñ",
                                "payload": "{\"command\": \"—à–∫–∞—Ñ\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üëî –ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è",
                                "payload": "{\"command\": \"–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üõã –ü—Ä–∏—Ö–æ–∂–∞—è",
                                "payload": "{\"command\": \"–ø—Ä–∏—Ö–æ–∂–∞—è\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üõÅ –ú–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π",
                                "payload": "{\"command\": \"–≤–∞–Ω–Ω–∞—è\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üõã –î—Ä—É–≥–∞—è –º–µ–±–µ–ª—å",
                                "payload": "{\"command\": \"–¥—Ä—É–≥–æ–µ\"}"
                            },
                            "color": "secondary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìû –°–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π",
                                "payload": "{\"command\": \"—Å–≤—è–∑–∞—Ç—å—Å—è_—Å–æ_–º–Ω–æ–π\"}"
                            },
                            "color": "positive"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_categories_keyboard(platform: Platform):
        # This method is now redundant, get_initial_keyboard will be used for categories
        return KeyboardManager.get_initial_keyboard(platform)

    @staticmethod
    def get_actions_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [KeyboardButton("–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"), KeyboardButton("–ù–∞–ø–∏—Å–∞—Ç—å –≤ –¢–ì")]
            ]
            return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ...")
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìû –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
                                "payload": "{\"command\": \"–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è\"}"
                            },
                            "color": "positive"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ –¢–ì",
                                "payload": "{\"command\": \"–Ω–∞–ø–∏—Å–∞—Ç—å_—Ç–≥\"}"
                            },
                            "color": "primary"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_contact_final_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [KeyboardButton(""), KeyboardButton("")],
                [KeyboardButton("üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"), ]
            ]
            return ReplyKeyboardMarkup(keyboard, resize_keyboard=True,
                                       input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏...")
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìû –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É",
                                "payload": "{\"command\": \"–ø–æ_—Ç–µ–ª–µ—Ñ–æ–Ω—É\"}"
                            },
                            "color": "positive"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram",
                                "payload": "{\"command\": \"—Å–æ–æ–±—â–µ–Ω–∏–µ_—Ç–≥\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ",
                                "payload": "{\"command\": \"–Ω–∞—á–∞—Ç—å_–∑–∞–Ω–æ–≤–æ\"}"
                            },
                            "color": "secondary"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_phone_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [KeyboardButton("üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä", request_contact=True)],
                [KeyboardButton("–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é")]
            ]
            return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [{
                        "action": {
                            "type": "callback",
                            "label": "üìû –í–≤–µ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω",
                            "payload": "{\"command\": \"–≤–≤–µ—Å—Ç–∏_—Ç–µ–ª–µ—Ñ–æ–Ω\"}"
                        },
                        "color": "positive"
                    }]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_kitchen_type_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–£–≥–ª–æ–≤–∞—è", callback_data="–∫—É—Ö–Ω—è_—É–≥–ª–æ–≤–∞—è")],
                [InlineKeyboardButton("–ü—Ä—è–º–∞—è", callback_data="–∫—É—Ö–Ω—è_–ø—Ä—è–º–∞—è")],
                [InlineKeyboardButton("–ü-–æ–±—Ä–∞–∑–Ω–∞—è", callback_data="–∫—É—Ö–Ω—è_–ø_–æ–±—Ä–∞–∑–Ω–∞—è")],
                [InlineKeyboardButton("–° –æ—Å—Ç—Ä–æ–≤–æ–º", callback_data="–∫—É—Ö–Ω—è_–æ—Å—Ç—Ä–æ–≤")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏")]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìê –£–≥–ª–æ–≤–∞—è",
                                "payload": "{\"command\": \"–∫—É—Ö–Ω—è_—É–≥–ª–æ–≤–∞—è\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìè –ü—Ä—è–º–∞—è",
                                "payload": "{\"command\": \"–∫—É—Ö–Ω—è_–ø—Ä—è–º–∞—è\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîÑ –ü-–æ–±—Ä–∞–∑–Ω–∞—è",
                                "payload": "{\"command\": \"–∫—É—Ö–Ω—è_–ø_–æ–±—Ä–∞–∑–Ω–∞—è\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üèù –° –æ—Å—Ç—Ä–æ–≤–æ–º",
                                "payload": "{\"command\": \"–∫—É—Ö–Ω—è_–æ—Å—Ç—Ä–æ–≤\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": "{\"command\": \"–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏\"}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_cabinet_type_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–†–∞—Å–ø–∞—à–Ω–æ–π", callback_data="—à–∫–∞—Ñ_—Ä–∞—Å–ø–∞—à–Ω–æ–π")],
                [InlineKeyboardButton("–ö—É–ø–µ", callback_data="—à–∫–∞—Ñ_–∫—É–ø–µ")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏")]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üö™ –†–∞—Å–ø–∞—à–Ω–æ–π",
                                "payload": "{\"command\": \"—à–∫–∞—Ñ_—Ä–∞—Å–ø–∞—à–Ω–æ–π\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üö∂ –ö—É–ø–µ",
                                "payload": "{\"command\": \"—à–∫–∞—Ñ_–∫—É–ø–µ\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": "{\"command\": \"–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏\"}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_hallway_type_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–ü—Ä—è–º–∞—è", callback_data="–ø—Ä–∏—Ö–æ–∂–∞—è_–ø—Ä—è–º–∞—è")],
                [InlineKeyboardButton("–£–≥–ª–æ–≤–∞—è", callback_data="–ø—Ä–∏—Ö–æ–∂–∞—è_—É–≥–ª–æ–≤–∞—è")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏")]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìè –ü—Ä—è–º–∞—è",
                                "payload": "{\"command\": \"–ø—Ä–∏—Ö–æ–∂–∞—è_–ø—Ä—è–º–∞—è\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìê –£–≥–ª–æ–≤–∞—è",
                                "payload": "{\"command\": \"–ø—Ä–∏—Ö–æ–∂–∞—è_—É–≥–ª–æ–≤–∞—è\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": "{\"command\": \"–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏\"}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_bathroom_type_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–¢—É–º–±–∞ –ø–æ–¥ —Ä–∞–∫–æ–≤–∏–Ω—É", callback_data="–≤–∞–Ω–Ω–∞—è_—Ç—É–º–±–∞")],
                [InlineKeyboardButton("–®–∫–∞—Ñ-–ø–µ–Ω–∞–ª", callback_data="–≤–∞–Ω–Ω–∞—è_–ø–µ–Ω–∞–ª")],
                [InlineKeyboardButton("–ó–µ—Ä–∫–∞–ª–æ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π", callback_data="–≤–∞–Ω–Ω–∞—è_–∑–µ—Ä–∫–∞–ª–æ")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏")]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üö∞ –¢—É–º–±–∞ –ø–æ–¥ —Ä–∞–∫–æ–≤–∏–Ω—É",
                                "payload": "{\"command\": \"–≤–∞–Ω–Ω–∞—è_—Ç—É–º–±–∞\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üß∫ –®–∫–∞—Ñ-–ø–µ–Ω–∞–ª",
                                "payload": "{\"command\": \"–≤–∞–Ω–Ω–∞—è_–ø–µ–Ω–∞–ª\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üí° –ó–µ—Ä–∫–∞–ª–æ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π",
                                "payload": "{\"command\": \"–≤–∞–Ω–Ω–∞—è_–∑–µ—Ä–∫–∞–ª–æ\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": "{\"command\": \"–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏\"}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_size_keyboard(platform: Platform, back_callback: str = "–Ω–∞–∑–∞–¥_—Ç–∏–ø"):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–¢–æ—á–Ω—ã–µ", callback_data="—Ä–∞–∑–º–µ—Ä_—Ç–æ—á–Ω—ã–µ")],
                [InlineKeyboardButton("–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ", callback_data="—Ä–∞–∑–º–µ—Ä_–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ")],
                [InlineKeyboardButton("–ù–µ –∑–Ω–∞—é", callback_data="—Ä–∞–∑–º–µ—Ä_–Ω–µ_–∑–Ω–∞—é")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data=back_callback)]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìè –¢–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã",
                                "payload": "{\"command\": \"—Ä–∞–∑–º–µ—Ä_—Ç–æ—á–Ω—ã–µ\"}"
                            },
                            "color": "positive"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìê –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ",
                                "payload": "{\"command\": \"—Ä–∞–∑–º–µ—Ä_–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "‚ùì –ù–µ –∑–Ω–∞—é",
                                "payload": "{\"command\": \"—Ä–∞–∑–º–µ—Ä_–Ω–µ_–∑–Ω–∞—é\"}"
                            },
                            "color": "secondary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": f"{{\"command\": \"{back_callback}\"}}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_material_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–õ–î–°–ü", callback_data="–º–∞—Ç–µ—Ä–∏–∞–ª_–ª–¥—Å–ø")],
                [InlineKeyboardButton("–ê–ì–¢", callback_data="–º–∞—Ç–µ—Ä–∏–∞–ª_–∞–≥—Ç")],
                [InlineKeyboardButton("–≠–º–∞–ª—å", callback_data="–º–∞—Ç–µ—Ä–∏–∞–ª_—ç–º–∞–ª—å")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="–Ω–∞–∑–∞–¥_—Ä–∞–∑–º–µ—Ä")]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üå≥ –õ–î–°–ü",
                                "payload": "{\"command\": \"–º–∞—Ç–µ—Ä–∏–∞–ª_–ª–¥—Å–ø\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "‚ú® –ê–ì–¢",
                                "payload": "{\"command\": \"–º–∞—Ç–µ—Ä–∏–∞–ª_–∞–≥—Ç\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üé® –≠–º–∞–ª—å",
                                "payload": "{\"command\": \"–º–∞—Ç–µ—Ä–∏–∞–ª_—ç–º–∞–ª—å\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": "{\"command\": \"–Ω–∞–∑–∞–¥_—Ä–∞–∑–º–µ—Ä\"}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_hardware_keyboard(platform: Platform):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–≠–∫–æ–Ω–æ–º", callback_data="—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_—ç–∫–æ–Ω–æ–º")],
                [InlineKeyboardButton("–°—Ç–∞–Ω–¥–∞—Ä—Ç", callback_data="—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_—Å—Ç–∞–Ω–¥–∞—Ä—Ç")],
                [InlineKeyboardButton("–ü—Ä–µ–º–∏—É–º", callback_data="—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_–ø—Ä–µ–º–∏—É–º")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="–Ω–∞–∑–∞–¥_–º–∞—Ç–µ—Ä–∏–∞–ª")]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üí∞ –≠–∫–æ–Ω–æ–º",
                                "payload": "{\"command\": \"—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_—ç–∫–æ–Ω–æ–º\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üíé –°—Ç–∞–Ω–¥–∞—Ä—Ç",
                                "payload": "{\"command\": \"—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_—Å—Ç–∞–Ω–¥–∞—Ä—Ç\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üëë –ü—Ä–µ–º–∏—É–º",
                                "payload": "{\"command\": \"—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_–ø—Ä–µ–º–∏—É–º\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": "{\"command\": \"–Ω–∞–∑–∞–¥_–º–∞—Ç–µ—Ä–∏–∞–ª\"}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_budget_keyboard(platform: Platform, back_callback: str = "–Ω–∞–∑–∞–¥_–ø—Ä–µ–¥—ã–¥—É—â–∏–π"):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–≠–∫–æ–Ω–æ–º - (–¥–æ 150 —Ç—ã—Å —Ä—É–±)", callback_data="–±—é–¥–∂–µ—Ç_—ç–∫–æ–Ω–æ–º")],
                [InlineKeyboardButton("–°—Ç–∞–Ω–¥–∞—Ä—Ç - (150-300 —Ç—ã—Å —Ä—É–±)", callback_data="–±—é–¥–∂–µ—Ç_—Å—Ç–∞–Ω–¥–∞—Ä—Ç")],
                [InlineKeyboardButton("–ü—Ä–µ–º–∏—É–º - (–æ—Ç 300 —Ç—ã—Å —Ä—É–±)", callback_data="–±—é–¥–∂–µ—Ç_–ø—Ä–µ–º–∏—É–º")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data=back_callback)]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üí∞ –≠–∫–æ–Ω–æ–º - (–¥–æ 150 —Ç—ã—Å —Ä—É–±)",
                                "payload": "{\"command\": \"–±—é–¥–∂–µ—Ç_—ç–∫–æ–Ω–æ–º\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üíé –°—Ç–∞–Ω–¥–∞—Ä—Ç - (150-300 —Ç—ã—Å —Ä—É–±)",
                                "payload": "{\"command\": \"–±—é–¥–∂–µ—Ç_—Å—Ç–∞–Ω–¥–∞—Ä—Ç\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üëë –ü—Ä–µ–º–∏—É–º - (–æ—Ç 300 —Ç—ã—Å —Ä—É–±)",
                                "payload": "{\"command\": \"–±—é–¥–∂–µ—Ç_–ø—Ä–µ–º–∏—É–º\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": f"{{\"command\": \"{back_callback}\"}}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)

    @staticmethod
    def get_deadline_keyboard(platform: Platform, back_callback: str = "–Ω–∞–∑–∞–¥_–±—é–¥–∂–µ—Ç"):
        if platform == Platform.TELEGRAM:
            keyboard = [
                [InlineKeyboardButton("–≠—Ç–æ—Ç –º–µ—Å—è—Ü", callback_data="—Å—Ä–æ–∫_–º–µ—Å—è—Ü")],
                [InlineKeyboardButton("1-2 –º–µ—Å—è—Ü–∞", callback_data="—Å—Ä–æ–∫_1_2")],
                [InlineKeyboardButton("3 –º–µ—Å—è—Ü–∞", callback_data="—Å—Ä–æ–∫_3")],
                [InlineKeyboardButton("–ü—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Å—å", callback_data="—Å—Ä–æ–∫_–ø—Ä–∏—Å–º–æ—Ç—Ä")],
                [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data=back_callback)]
            ]
            return InlineKeyboardMarkup(keyboard)
        else:  # VK
            keyboard = {
                "inline": True,
                "buttons": [
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üóì –≠—Ç–æ—Ç –º–µ—Å—è—Ü",
                                "payload": "{\"command\": \"—Å—Ä–æ–∫_–º–µ—Å—è—Ü\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "‚è≥ 1-2 –º–µ—Å—è—Ü–∞",
                                "payload": "{\"command\": \"—Å—Ä–æ–∫_1_2\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üìÖ 3 –º–µ—Å—è—Ü–∞",
                                "payload": "{\"command\": \"—Å—Ä–æ–∫_3\"}"
                            },
                            "color": "primary"
                        },
                        {
                            "action": {
                                "type": "callback",
                                "label": "üëÄ –ü—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Å—å",
                                "payload": "{\"command\": \"—Å—Ä–æ–∫_–ø—Ä–∏—Å–º–æ—Ç—Ä\"}"
                            },
                            "color": "primary"
                        }
                    ],
                    [
                        {
                            "action": {
                                "type": "callback",
                                "label": "üîô –ù–∞–∑–∞–¥",
                                "payload": f"{{\"command\": \"{back_callback}\"}}"
                            },
                            "color": "negative"
                        }
                    ]
                ]
            }
            return json.dumps(keyboard, ensure_ascii=False)


# –Ø–¥—Ä–æ –±–æ—Ç–∞ —Å –æ–±—â–µ–π –ª–æ–≥–∏–∫–æ–π
class FurnitureBotCore:
    def __init__(self):
        self.adapters = {}

    def register_adapter(self, platform: Platform, adapter):
        self.adapters[platform] = adapter

    async def send_message(self, platform: Platform, user_id: int, text: str, keyboard=None):
        if platform in self.adapters:
            await self.adapters[platform].send_message(user_id, text, keyboard)

    async def edit_message(self, platform: Platform, user_id: int, message_id: int, text: str, keyboard=None):
        if platform in self.adapters:
            await self.adapters[platform].edit_message(user_id, message_id, text, keyboard)

    def get_user_data(self, user_id: int) -> Dict[str, Any]:
        if user_id not in user_data:
            user_data[user_id] = {}
        return user_data[user_id]

    def clear_user_data(self, user_id: int):
        if user_id in user_data:
            del user_data[user_id]

    async def handle_start(self, platform: Platform, user_id: int):
        self.clear_user_data(user_id)

        await self.send_photo_album(
            platform, user_id,
            WELCOME_PHOTOS,
            WELCOME_MESSAGE,
            KeyboardManager.get_initial_keyboard(platform)
        )

    async def request_name(self, platform: Platform, user_id: int, message_id: int = None):
        text = "üë§ **–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –∏–º—è:"
        if message_id and platform == Platform.TELEGRAM:
            await self.edit_message(platform, user_id, message_id, text)
        else:
            await self.send_message(platform, user_id, text)
        self.get_user_data(user_id)["waiting_for"] = "name"

    async def handle_callback(self, platform: Platform, user_id: int, data: str, message_id: int = None):
        user_data = self.get_user_data(user_id)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
        if data.startswith("–Ω–∞–∑–∞–¥_"):
            await self.handle_back_button(platform, user_id, data, message_id)
            return

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π"
        if data == "—Å–≤—è–∑–∞—Ç—å—Å—è_—Å–æ_–º–Ω–æ–π":
            user_data["category"] = "—Å–≤—è–∑–∞—Ç—å—Å—è_—Å–æ_–º–Ω–æ–π"
            await self.request_name(platform, user_id, message_id)
            return

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if data == "–∫—É—Ö–Ω—è":
            user_data["category"] = "–∫—É—Ö–Ω—è"
            user_data["current_step"] = "kitchen_type"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üè† **–ö—É—Ö–Ω—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫—É—Ö–Ω–∏:",
                KeyboardManager.get_kitchen_type_keyboard(platform)
            )

        elif data == "—à–∫–∞—Ñ":
            user_data["category"] = "—à–∫–∞—Ñ"
            user_data["current_step"] = "cabinet_type"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üö™ **–®–∫–∞—Ñ**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —à–∫–∞—Ñ–∞:",
                KeyboardManager.get_cabinet_type_keyboard(platform)
            )

        elif data == "–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è":
            user_data["category"] = "–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è"
            user_data["current_step"] = "size"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üëî **–ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è**\n\n–ö–∞–∫–∏–µ —É –≤–∞—Å —Ä–∞–∑–º–µ—Ä—ã?",
                KeyboardManager.get_size_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
            )

        elif data == "–ø—Ä–∏—Ö–æ–∂–∞—è":
            user_data["category"] = "–ø—Ä–∏—Ö–æ–∂–∞—è"
            user_data["current_step"] = "hallway_type"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üõã **–ü—Ä–∏—Ö–æ–∂–∞—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—Ö–æ–∂–µ–π:",
                KeyboardManager.get_hallway_type_keyboard(platform)
            )

        elif data == "–≤–∞–Ω–Ω–∞—è":
            user_data["category"] = "–≤–∞–Ω–Ω–∞—è"
            user_data["current_step"] = "bathroom_type"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üõÅ **–ú–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ–±–µ–ª–∏ –¥–ª—è –≤–∞–Ω–Ω–æ–π:",
                KeyboardManager.get_bathroom_type_keyboard(platform)
            )

        elif data == "–¥—Ä—É–≥–æ–µ":
            user_data["category"] = "–¥—Ä—É–≥–æ–µ"
            user_data["current_step"] = "other_furniture_text"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üõã **–î—Ä—É–≥–∞—è –º–µ–±–µ–ª—å**\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∞—è –º–µ–±–µ–ª—å –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:"
            )
            user_data["waiting_for"] = "other_furniture_description"

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –ö–£–•–ù–Ø
        elif data.startswith("–∫—É—Ö–Ω—è_"):
            if data == "–∫—É—Ö–Ω—è_—É–≥–ª–æ–≤–∞—è":
                user_data["kitchen_type"] = "–£–≥–ª–æ–≤–∞—è"
            elif data == "–∫—É—Ö–Ω—è_–ø—Ä—è–º–∞—è":
                user_data["kitchen_type"] = "–ü—Ä—è–º–∞—è"
            elif data == "–∫—É—Ö–Ω—è_–ø_–æ–±—Ä–∞–∑–Ω–∞—è":
                user_data["kitchen_type"] = "–ü-–æ–±—Ä–∞–∑–Ω–∞—è"
            elif data == "–∫—É—Ö–Ω—è_–æ—Å—Ç—Ä–æ–≤":
                user_data["kitchen_type"] = "–° –æ—Å—Ç—Ä–æ–≤–æ–º"

            user_data["current_step"] = "size"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üìè **–†–∞–∑–º–µ—Ä—ã**\n\n–ö–∞–∫–∏–µ —É –≤–∞—Å —Ä–∞–∑–º–µ—Ä—ã?",
                KeyboardManager.get_size_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_—Ç–∏–ø")
            )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –ü–†–ò–•–û–ñ–ê–Ø
        elif data.startswith("–ø—Ä–∏—Ö–æ–∂–∞—è_"):
            if data == "–ø—Ä–∏—Ö–æ–∂–∞—è_–ø—Ä—è–º–∞—è":
                user_data["hallway_type"] = "–ü—Ä—è–º–∞—è"
            elif data == "–ø—Ä–∏—Ö–æ–∂–∞—è_—É–≥–ª–æ–≤–∞—è":
                user_data["hallway_type"] = "–£–≥–ª–æ–≤–∞—è"

            user_data["current_step"] = "size"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üìè **–†–∞–∑–º–µ—Ä—ã**\n\n–ö–∞–∫–∏–µ —É –≤–∞—Å —Ä–∞–∑–º–µ—Ä—ã?",
                KeyboardManager.get_size_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_—Ç–∏–ø")
            )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –í–ê–ù–ù–ê–Ø
        elif data.startswith("–≤–∞–Ω–Ω–∞—è_"):
            if data == "–≤–∞–Ω–Ω–∞—è_—Ç—É–º–±–∞":
                user_data["bathroom_type"] = "–¢—É–º–±–∞ –ø–æ–¥ —Ä–∞–∫–æ–≤–∏–Ω—É"
            elif data == "–≤–∞–Ω–Ω–∞—è_–ø–µ–Ω–∞–ª":
                user_data["bathroom_type"] = "–®–∫–∞—Ñ-–ø–µ–Ω–∞–ª"
            elif data == "–≤–∞–Ω–Ω–∞—è_–∑–µ—Ä–∫–∞–ª–æ":
                user_data["bathroom_type"] = "–ó–µ—Ä–∫–∞–ª–æ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π"

            user_data["current_step"] = "size"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üìè **–†–∞–∑–º–µ—Ä—ã**\n\n–ö–∞–∫–∏–µ —É –≤–∞—Å —Ä–∞–∑–º–µ—Ä—ã?",
                KeyboardManager.get_size_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_—Ç–∏–ø")
            )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ (–æ–±—â–µ–µ –¥–ª—è –ö—É—Ö–Ω–∏, –ì–∞—Ä–¥–µ—Ä–æ–±–Ω–æ–π, –ü—Ä–∏—Ö–æ–∂–µ–π, –í–∞–Ω–Ω–æ–π)
        elif data.startswith("—Ä–∞–∑–º–µ—Ä_"):
            if data == "—Ä–∞–∑–º–µ—Ä_—Ç–æ—á–Ω—ã–µ":
                user_data["size"] = "–¢–æ—á–Ω—ã–µ"
            elif data == "—Ä–∞–∑–º–µ—Ä_–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ":
                user_data["size"] = "–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ"
            elif data == "—Ä–∞–∑–º–µ—Ä_–Ω–µ_–∑–Ω–∞—é":
                user_data["size"] = "–ù–µ –∑–Ω–∞—é"

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            category = user_data.get("category", "")

            if category == "–∫—É—Ö–Ω—è":
                user_data["current_step"] = "material"
                await self.send_material_options(platform, user_id, message_id)
            elif category in ["–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è", "–ø—Ä–∏—Ö–æ–∂–∞—è", "–≤–∞–Ω–Ω–∞—è", "—à–∫–∞—Ñ", "–¥—Ä—É–≥–æ–µ"]:
                user_data["current_step"] = "budget"
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üí∞ **–ë—é–¥–∂–µ—Ç**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç:",
                    KeyboardManager.get_budget_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_—Ä–∞–∑–º–µ—Ä")
                )

        elif data.startswith("–º–∞—Ç–µ—Ä–∏–∞–ª_"):
            if data == "–º–∞—Ç–µ—Ä–∏–∞–ª_–ª–¥—Å–ø":
                user_data["material"] = "–õ–î–°–ü"
            elif data == "–º–∞—Ç–µ—Ä–∏–∞–ª_–∞–≥—Ç":
                user_data["material"] = "–ê–ì–¢"
            elif data == "–º–∞—Ç–µ—Ä–∏–∞–ª_—ç–º–∞–ª—å":
                user_data["material"] = "–≠–º–∞–ª—å"

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            material_key = data.replace("–º–∞—Ç–µ—Ä–∏–∞–ª_", "")
            photo_url = MATERIAL_PHOTOS.get(material_key)
            if photo_url:
                await self.send_photo_album(platform, user_id, [photo_url], f"üì∏ –ú–∞—Ç–µ—Ä–∏–∞–ª: {user_data['material']}")

            user_data["current_step"] = "hardware"
            await self.send_message(
                platform, user_id,
                "üîß **–§—É—Ä–Ω–∏—Ç—É—Ä–∞**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å —Ñ—É—Ä–Ω–∏—Ç—É—Ä—ã:",
                KeyboardManager.get_hardware_keyboard(platform)
            )

        elif data.startswith("—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_"):
            if data == "—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_—ç–∫–æ–Ω–æ–º":
                user_data["hardware"] = "–≠–∫–æ–Ω–æ–º"
            elif data == "—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_—Å—Ç–∞–Ω–¥–∞—Ä—Ç":
                user_data["hardware"] = "–°—Ç–∞–Ω–¥–∞—Ä—Ç"
            elif data == "—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞_–ø—Ä–µ–º–∏—É–º":
                user_data["hardware"] = "–ü—Ä–µ–º–∏—É–º"

            user_data["current_step"] = "budget"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üí∞ **–ë—é–¥–∂–µ—Ç**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç:",
                KeyboardManager.get_budget_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞")
            )

        elif data.startswith("–±—é–¥–∂–µ—Ç_"):
            if data == "–±—é–¥–∂–µ—Ç_—ç–∫–æ–Ω–æ–º":
                user_data["budget"] = "–≠–∫–æ–Ω–æ–º"
            elif data == "–±—é–¥–∂–µ—Ç_—Å—Ç–∞–Ω–¥–∞—Ä—Ç":
                user_data["budget"] = "–°—Ç–∞–Ω–¥–∞—Ä—Ç"
            elif data == "–±—é–¥–∂–µ—Ç_–ø—Ä–µ–º–∏—É–º":
                user_data["budget"] = "–ü—Ä–µ–º–∏—É–º"

            user_data["current_step"] = "deadline"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üìÖ **–°—Ä–æ–∫–∏ –∑–∞–∫–∞–∑–∞**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫–∏:",
                KeyboardManager.get_deadline_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_–±—é–¥–∂–µ—Ç")
            )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –®–ö–ê–§
        elif data.startswith("—à–∫–∞—Ñ_"):
            if data == "—à–∫–∞—Ñ_—Ä–∞—Å–ø–∞—à–Ω–æ–π":
                user_data["cabinet_type"] = "–†–∞—Å–ø–∞—à–Ω–æ–π"
            elif data == "—à–∫–∞—Ñ_–∫—É–ø–µ":
                user_data["cabinet_type"] = "–ö—É–ø–µ"

            user_data["current_step"] = "budget"
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üí∞ **–ë—é–¥–∂–µ—Ç**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç:",
                KeyboardManager.get_budget_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_—Ç–∏–ø")
            )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ä–æ–∫–æ–≤ –∑–∞–∫–∞–∑–∞ (–ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–ø—Ä–æ—Å—É –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
        elif data.startswith("—Å—Ä–æ–∫_"):
            if data == "—Å—Ä–æ–∫_–º–µ—Å—è—Ü":
                user_data["deadline"] = "–≠—Ç–æ—Ç –º–µ—Å—è—Ü"
            elif data == "—Å—Ä–æ–∫_1_2":
                user_data["deadline"] = "1-2 –º–µ—Å—è—Ü–∞"
            elif data == "—Å—Ä–æ–∫_3":
                user_data["deadline"] = "3 –º–µ—Å—è—Ü–∞"
            elif data == "—Å—Ä–æ–∫_–ø—Ä–∏—Å–º–æ—Ç—Ä":
                user_data["deadline"] = "–ü—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Å—å"

            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è
            await self.request_name(platform, user_id, message_id)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –¥–ª—è VK
        elif data == "–≤–≤–µ—Å—Ç–∏_—Ç–µ–ª–µ—Ñ–æ–Ω":
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üì± **–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:**\n\n–§–æ—Ä–º–∞—Ç: +7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX"
            )
            user_data["waiting_for"] = "phone"

        elif data == "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è":
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üìû **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è**\n\n–î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:\n\n"
                "üí¨ –¢–µ–ª–µ–≥—Ä–∞–º: @max_lap555\n"
                "üì± WhatsApp: +79063405556",
                KeyboardManager.get_actions_keyboard(platform)
            )

        elif data == "–Ω–∞–ø–∏—Å–∞—Ç—å_—Ç–≥":
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üí¨ **–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram**\n\n"
                "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Telegram: @max_lap555\n"
                "–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä: +79063405556",
                KeyboardManager.get_actions_keyboard(platform)
            )

        elif data == "–ø–æ_—Ç–µ–ª–µ—Ñ–æ–Ω—É":
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üìû **–°–≤—è–∑—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É**\n\n"
                "–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –ø–æ –Ω–æ–º–µ—Ä—É:\n"
                "üì± +79063405556\n\n"
                "–ú—ã –¥–æ—Å—Ç—É–ø–Ω—ã:\n"
                "‚Ä¢ –ü–Ω-–ü—Ç: 9:00-18:00\n"
                "‚Ä¢ –°–±: 10:00-16:00",
                KeyboardManager.get_contact_final_keyboard(platform)
            )

        elif data == "—Å–æ–æ–±—â–µ–Ω–∏–µ_—Ç–≥":
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üí¨ **–°–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram**\n\n"
                "–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram:\n"
                "üë§ @max_lap555\n\n"
                "–ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ:\n"
                "https://t.me/max_lap555",
                KeyboardManager.get_contact_final_keyboard(platform)
            )

        elif data == "–Ω–∞—á–∞—Ç—å_–∑–∞–Ω–æ–≤–æ":
            self.clear_user_data(user_id)
            await self.handle_start(platform, user_id)

    async def send_material_options(self, platform: Platform, user_id: int, message_id: int = None):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤—ã–±–æ—Ä–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"""
        # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
        await self.send_or_edit_message(
            platform, user_id, message_id,
            "üé® **–ú–∞—Ç–µ—Ä–∏–∞–ª —Ñ–∞—Å–∞–¥–æ–≤**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª:",
            KeyboardManager.get_material_keyboard(platform)
        )

        # –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–æ—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        for material_name, photo_url in MATERIAL_PHOTOS.items():
            material_display_name = material_name.upper()
            await self.send_photo_album(
                platform, user_id,
                [photo_url],
                f"üì∏ –ú–∞—Ç–µ—Ä–∏–∞–ª: {material_display_name}"
            )

    async def send_or_edit_message(self, platform: Platform, user_id: int, message_id: int, text: str, keyboard=None):
        if message_id and platform == Platform.TELEGRAM:  # Only edit message for Telegram
            await self.edit_message(platform, user_id, message_id, text, keyboard)
        else:
            await self.send_message(platform, user_id, text, keyboard)

    async def send_photo_album(self, platform: Platform, user_id: int, photo_urls: list, text: str, keyboard=None):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª—å–±–æ–º–∞ —Ñ–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º"""
        if platform in self.adapters:
            await self.adapters[platform].send_photo_album(user_id, photo_urls, text, keyboard)

    async def handle_back_button(self, platform: Platform, user_id: int, data: str, message_id: int = None):
        back_step = data.replace("–Ω–∞–∑–∞–¥_", "")
        user_data = self.get_user_data(user_id)

        if back_step == "–∫–∞—Ç–µ–≥–æ—Ä–∏–∏":
            self.clear_user_data(user_id)
            await self.send_or_edit_message(
                platform, user_id, message_id,
                WELCOME_MESSAGE,
                KeyboardManager.get_initial_keyboard(platform)
            )

        elif back_step == "—Ç–∏–ø":  # For kitchen, wardrobe, hallway, bathroom
            category = user_data.get("category", "")
            if category == "–∫—É—Ö–Ω—è":
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üè† **–ö—É—Ö–Ω—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫—É—Ö–Ω–∏:",
                    KeyboardManager.get_kitchen_type_keyboard(platform)
                )
            elif category == "—à–∫–∞—Ñ":
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üö™ **–®–∫–∞—Ñ**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —à–∫–∞—Ñ–∞:",
                    KeyboardManager.get_cabinet_type_keyboard(platform)
                )
            elif category == "–ø—Ä–∏—Ö–æ–∂–∞—è":
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üõã **–ü—Ä–∏—Ö–æ–∂–∞—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—Ö–æ–∂–µ–π:",
                    KeyboardManager.get_hallway_type_keyboard(platform)
                )
            elif category == "–≤–∞–Ω–Ω–∞—è":
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üõÅ **–ú–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ–±–µ–ª–∏ –¥–ª—è –≤–∞–Ω–Ω–æ–π:",
                    KeyboardManager.get_bathroom_type_keyboard(platform)
                )

        elif back_step == "—Ä–∞–∑–º–µ—Ä":
            category = user_data.get("category", "")
            if category == "–∫—É—Ö–Ω—è":
                user_data["current_step"] = "kitchen_type"
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üè† **–ö—É—Ö–Ω—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫—É—Ö–Ω–∏:",
                    KeyboardManager.get_kitchen_type_keyboard(platform)
                )
            elif category == "–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è":
                user_data["current_step"] = "size"
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üëî **–ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è**\n\n–ö–∞–∫–∏–µ —É –≤–∞—Å —Ä–∞–∑–º–µ—Ä—ã?",
                    KeyboardManager.get_size_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
                )
            elif category == "–ø—Ä–∏—Ö–æ–∂–∞—è":
                user_data["current_step"] = "hallway_type"
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üõã **–ü—Ä–∏—Ö–æ–∂–∞—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—Ö–æ–∂–µ–π:",
                    KeyboardManager.get_hallway_type_keyboard(platform)
                )
            elif category == "–≤–∞–Ω–Ω–∞—è":
                user_data["current_step"] = "bathroom_type"
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üõÅ **–ú–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ–±–µ–ª–∏ –¥–ª—è –≤–∞–Ω–Ω–æ–π:",
                    KeyboardManager.get_bathroom_type_keyboard(platform)
                )
            elif category == "—à–∫–∞—Ñ":
                user_data["current_step"] = "cabinet_type"
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üö™ **–®–∫–∞—Ñ**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —à–∫–∞—Ñ–∞:",
                    KeyboardManager.get_cabinet_type_keyboard(platform)
                )

        elif back_step == "–º–∞—Ç–µ—Ä–∏–∞–ª":
            await self.send_material_options(platform, user_id, message_id)

        elif back_step == "—Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞":
            await self.send_or_edit_message(
                platform, user_id, message_id,
                "üîß **–§—É—Ä–Ω–∏—Ç—É—Ä–∞**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å —Ñ—É—Ä–Ω–∏—Ç—É—Ä—ã:",
                KeyboardManager.get_hardware_keyboard(platform)
            )

        elif back_step == "–±—é–¥–∂–µ—Ç":
            category = user_data.get("category", "")
            if category == "–∫—É—Ö–Ω—è":
                await self.send_or_edit_message(
                    platform, user_id, message_id,
                    "üîß **–§—É—Ä–Ω–∏—Ç—É—Ä–∞**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å —Ñ—É—Ä–Ω–∏—Ç—É—Ä—ã:",
                    KeyboardManager.get_hardware_keyboard(platform)
                )
            elif category in ["—à–∫–∞—Ñ", "–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è", "–ø—Ä–∏—Ö–æ–∂–∞—è", "–≤–∞–Ω–Ω–∞—è", "–¥—Ä—É–≥–æ–µ"]:
                if category == "—à–∫–∞—Ñ":
                    await self.send_or_edit_message(
                        platform, user_id, message_id,
                        "üö™ **–®–∫–∞—Ñ**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —à–∫–∞—Ñ–∞:",
                        KeyboardManager.get_cabinet_type_keyboard(platform)
                    )
                elif category == "–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è":
                    await self.send_or_edit_message(
                        platform, user_id, message_id,
                        "üëî **–ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è**\n\n–ö–∞–∫–∏–µ —É –≤–∞—Å —Ä–∞–∑–º–µ—Ä—ã?",
                        KeyboardManager.get_size_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
                    )
                elif category == "–ø—Ä–∏—Ö–æ–∂–∞—è":
                    await self.send_or_edit_message(
                        platform, user_id, message_id,
                        "üõã **–ü—Ä–∏—Ö–æ–∂–∞—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—Ö–æ–∂–µ–π:",
                        KeyboardManager.get_hallway_type_keyboard(platform)
                    )
                elif category == "–≤–∞–Ω–Ω–∞—è":
                    await self.send_or_edit_message(
                        platform, user_id, message_id,
                        "üõÅ **–ú–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ–±–µ–ª–∏ –¥–ª—è –≤–∞–Ω–Ω–æ–π:",
                        KeyboardManager.get_bathroom_type_keyboard(platform)
                    )
                elif category == "–¥—Ä—É–≥–æ–µ":
                    await self.send_or_edit_message(
                        platform, user_id, message_id,
                        "üõã **–î—Ä—É–≥–∞—è –º–µ–±–µ–ª—å**\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∞—è –º–µ–±–µ–ª—å –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:"
                    )
                    user_data["waiting_for"] = "other_furniture_description"

        elif back_step == "–¥—Ä—É–≥–æ–µ":
            await self.send_or_edit_message(
                platform, user_id, message_id,
                WELCOME_MESSAGE,
                KeyboardManager.get_initial_keyboard(platform)
            )

    async def handle_text_message(self, platform: Platform, user_id: int, text: str):
        user_data = self.get_user_data(user_id)

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã
        normalized_text = text.lower().strip()

        # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
        start_commands = ["/start", "start", "–Ω–∞—á–∞—Ç—å", "—Å—Ç–∞—Ä—Ç", "go", "–º–µ–Ω—é"]

        if normalized_text in start_commands:
            await self.handle_start(platform, user_id)
            return

        # –ï—Å–ª–∏ –æ–∂–∏–¥–∞–µ–º –∏–º—è
        if user_data.get("waiting_for") == "name":
            user_data["name"] = text
            user_data["waiting_for"] = "phone"

            await self.send_message(
                platform, user_id,
                f"üë§ **–ò–º—è –ø—Ä–∏–Ω—è—Ç–æ:** {text}\n\n"
                "üì± **–¢–µ–ª–µ—Ñ–æ–Ω**\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:",
                KeyboardManager.get_phone_keyboard(platform)
            )
            return

        # –ï—Å–ª–∏ –æ–∂–∏–¥–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
        if user_data.get("waiting_for") == "phone":
            # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            if len(text) >= 10 and all(char.isdigit() or char in ["+", "(", ")", "-", " "] for char in text):
                user_data["phone"] = text
                user_data["waiting_for"] = None
                await self.send_final_summary(platform, user_id)
            else:
                await self.send_message(
                    platform, user_id,
                    "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX:"
                )
            return

        # –ï—Å–ª–∏ –æ–∂–∏–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥—Ä—É–≥–æ–π –º–µ–±–µ–ª–∏
        if user_data.get("waiting_for") == "other_furniture_description":
            user_data["other_furniture_description"] = text
            user_data["waiting_for"] = None
            user_data["current_step"] = "budget"
            await self.send_or_edit_message(
                platform, user_id, None,
                "üí∞ **–ë—é–¥–∂–µ—Ç**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç:",
                KeyboardManager.get_budget_keyboard(platform, back_callback="–Ω–∞–∑–∞–¥_–¥—Ä—É–≥–æ–µ")
            )
            return

        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π –∏ –Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–≤–æ–¥
        await self.send_message(
            platform, user_id,
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω—è–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start.",
            KeyboardManager.get_initial_keyboard(platform)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –Ω–∞—á–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
        )

    async def send_final_summary(self, platform: Platform, user_id: int):
        user_data = self.get_user_data(user_id)
        summary = "‚úÖ **–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!**\n\n"

        category = user_data.get("category", "–ù–µ —É–∫–∞–∑–∞–Ω–æ")

        if category == "—Å–≤—è–∑–∞—Ç—å—Å—è_—Å–æ_–º–Ω–æ–π":
            summary += "–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n"
        else:
            summary += f"**–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ {category.capitalize()}:**\n"

        if category == "–∫—É—Ö–Ω—è":
            summary += f"‚Ä¢ –¢–∏–ø –∫—É—Ö–Ω–∏: {user_data.get('kitchen_type', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            summary += f"‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {user_data.get('size', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            summary += f"‚Ä¢ –ú–∞—Ç–µ—Ä–∏–∞–ª: {user_data.get('material', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            summary += f"‚Ä¢ –§—É—Ä–Ω–∏—Ç—É—Ä–∞: {user_data.get('hardware', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        elif category == "—à–∫–∞—Ñ":
            summary += f"‚Ä¢ –¢–∏–ø —à–∫–∞—Ñ–∞: {user_data.get('cabinet_type', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            summary += f"‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {user_data.get('size', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        elif category == "–≥–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è":
            summary += f"‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {user_data.get('size', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        elif category == "–ø—Ä–∏—Ö–æ–∂–∞—è":
            summary += f"‚Ä¢ –¢–∏–ø –ø—Ä–∏—Ö–æ–∂–µ–π: {user_data.get('hallway_type', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            summary += f"‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {user_data.get('size', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        elif category == "–≤–∞–Ω–Ω–∞—è":
            summary += f"‚Ä¢ –¢–∏–ø –º–µ–±–µ–ª–∏ –¥–ª—è –≤–∞–Ω–Ω–æ–π: {user_data.get('bathroom_type', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            summary += f"‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {user_data.get('size', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        elif category == "–¥—Ä—É–≥–æ–µ":
            summary += f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –º–µ–±–µ–ª–∏: {user_data.get('other_furniture_description', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"

        if category != "—Å–≤—è–∑–∞—Ç—å—Å—è_—Å–æ_–º–Ω–æ–π":
            summary += f"‚Ä¢ –ë—é–¥–∂–µ—Ç: {user_data.get('budget', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            summary += f"‚Ä¢ –°—Ä–æ–∫–∏: {user_data.get('deadline', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"

        summary += f"‚Ä¢ –ò–º—è: {user_data.get('name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        summary += f"‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: {user_data.get('phone', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n\n"

        summary += "üìû –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:\n"
        summary += "üí¨ –¢–µ–ª–µ–≥—Ä–∞–º: @max_lap555\n"
        summary += "üì± WhatsApp: +79063405556\n\n"
        summary += "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."

        await self.send_message(
            platform, user_id, summary,
            KeyboardManager.get_contact_final_keyboard(platform)
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É –≤ Telegram –≥—Ä—É–ø–ø—É
        send_telegram_application(user_data)

        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–≤–æ–¥–∫–∏
        self.clear_user_data(user_id)


# –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è Telegram
class TelegramAdapter:
    def __init__(self, token: str, bot_core: FurnitureBotCore):
        self.bot_core = bot_core
        self.application = ApplicationBuilder().token(token).build()
        self.setup_handlers()

    def setup_handlers(self):
        self.application.add_handler(CommandHandler("start", self.handle_start))
        self.application.add_handler(CallbackQueryHandler(self.handle_callback))
        self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_text))
        self.application.add_handler(MessageHandler(filters.CONTACT, self.handle_contact))

    async def handle_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        await self.bot_core.handle_start(Platform.TELEGRAM, update.effective_user.id)

    async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        query = update.callback_query
        await query.answer()
        await self.bot_core.handle_callback(
            Platform.TELEGRAM,
            update.effective_user.id,
            query.data,
            query.message.message_id
        )

    async def handle_text(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        await self.bot_core.handle_text_message(
            Platform.TELEGRAM,
            update.effective_user.id,
            update.message.text
        )

    async def send_photo_album(self, user_id: int, photo_urls: list, text: str, keyboard=None):
        try:
            # –°–æ–∑–¥–∞–µ–º –º–µ–¥–∏–∞–≥—Ä—É–ø–ø—É (–º–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)
            media_group = []

            for i, photo_url in enumerate(photo_urls[:10]):  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
                if i == 0:
                    # –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é (—Ç–µ–∫—Å—Ç–æ–º)
                    media_group.append(InputMediaPhoto(
                        media=photo_url,
                        caption=text,
                        parse_mode=None
                    ))
                else:
                    # –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
                    media_group.append(InputMediaPhoto(
                        media=photo_url
                    ))

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª—å–±–æ–º
            await self.application.bot.send_media_group(
                chat_id=user_id,
                media=media_group
            )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            if keyboard:
                await self.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", keyboard)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º–∞ –≤ Telegram: {e}")
            # Fallback - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self.send_message(user_id, text, keyboard)

    async def handle_contact(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.effective_user.id
        user_data = self.bot_core.get_user_data(user_id)

        if user_data.get("waiting_for") == "phone":
            phone_number = update.message.contact.phone_number
            user_data["phone"] = phone_number
            user_data["waiting_for"] = None
            await self.bot_core.send_final_summary(Platform.TELEGRAM, user_id)

    async def send_message(self, user_id: int, text: str, keyboard=None):
        # –£–±–∏—Ä–∞–µ–º parse_mode —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ —Å Markdown
        await self.application.bot.send_message(
            chat_id=user_id, text=text, reply_markup=keyboard
        )

    async def edit_message(self, user_id: int, message_id: int, text: str, keyboard=None):
        await self.application.bot.edit_message_text(
            chat_id=user_id, message_id=message_id, text=text, reply_markup=keyboard
        )

    def run(self):
        logger.info("–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...")
        self.application.run_polling()


# –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è VK
class VKAdapter:
    def __init__(self, token: str, group_id: str, bot_core: FurnitureBotCore):
        self.bot_core = bot_core
        self.vk_session = vk_api.VkApi(token=token)
        self.vk = self.vk_session.get_api()
        self.group_id = group_id

    def run(self):
        logger.info("–ó–∞–ø—É—Å–∫ VK –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Long Poll...")
        try:
            longpoll = VkBotLongPoll(self.vk_session, self.group_id)
            logger.info("‚úì Long Poll –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!")

            logger.info("VK –±–æ—Ç –≥–æ—Ç–æ–≤! –ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É")

            for event in longpoll.listen():
                logger.info(f"VK: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ —Ç–∏–ø–∞: {event.type}")

                if event.type == VkBotEventType.MESSAGE_NEW:
                    self.handle_message(event)
                elif event.type == VkBotEventType.MESSAGE_EVENT:
                    self.handle_callback(event)
                else:
                    logger.info(f"VK: –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è: {event.type}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ VK –±–æ—Ç–∞: {e}")
            import traceback
            logger.error(f"–î–µ—Ç–∞–ª–∏: {traceback.format_exc()}")

    def handle_message(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            user_id = event.obj.message["from_id"]
            text = event.obj.message["text"]

            logger.info(f"VK: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: \'{text}\'")

            # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
            threading.Thread(
                target=lambda: asyncio.run(
                    self.process_message(user_id, text)
                )
            ).start()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    def handle_callback(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
        try:
            logger.info(f"VK: Callback —Å–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!")
            logger.info(f"VK: Event object: {event.obj}")

            user_id = event.obj.user_id
            payload = event.obj.payload

            logger.info(f"VK: Callback –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            logger.info(f"VK: Payload: {payload}")

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∏–∑ payload
            if isinstance(payload, dict):
                command = payload.get("command", "")
            elif isinstance(payload, str):
                # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON —Å—Ç—Ä–æ–∫—É
                try:
                    payload_dict = json.loads(payload)
                    command = payload_dict.get("command", "")
                except:
                    command = payload
            else:
                command = str(payload)

            logger.info(f"VK: –ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: \'{command}\'")

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ callback (–í–ê–ñ–ù–û!) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π json
            self.vk.messages.sendMessageEventAnswer(
                event_id=event.obj.event_id,
                user_id=user_id,
                peer_id=event.obj.peer_id,
                event_data=json.dumps({"type": "show_snackbar", "text": "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é..."})
            )

            logger.info("VK: –û—Ç–≤–µ—Ç –Ω–∞ callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")

            # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥—ã
            threading.Thread(
                target=lambda: asyncio.run(
                    self.process_callback(user_id, command)
                )
            ).start()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {e}")
            import traceback
            logger.error(f"–î–µ—Ç–∞–ª–∏: {traceback.format_exc()}")

    async def process_message(self, user_id: int, text: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            normalized_text = text.lower().strip()

            if normalized_text in ["/start", "start", "–Ω–∞—á–∞—Ç—å", "–º–µ–Ω—é"]:
                await self.bot_core.handle_start(Platform.VK, user_id)
            else:
                await self.bot_core.handle_text_message(Platform.VK, user_id, text)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ process_message: {e}")

    async def send_photo_album(self, user_id: int, photo_urls: list, text: str, keyboard=None):
        try:
            attachments = []

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–æ—Ç–æ (VK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ - 10 –≤–ª–æ–∂–µ–Ω–∏–π)
            for photo_url in photo_urls[:10]:
                attachment = await self.upload_photo(photo_url)
                if attachment:
                    attachments.append(attachment)

            params = {
                "user_id": user_id,
                "message": text,
                "random_id": get_random_id(),
                "dont_parse_links": 1
            }

            if attachments:
                params["attachment"] = ",".join(attachments)
                logger.info(f"VK: –î–æ–±–∞–≤–ª–µ–Ω—ã {len(attachments)} —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º")

            if keyboard:
                params["keyboard"] = keyboard

            result = self.vk.messages.send(**params)
            logger.info(f"VK: –§–æ—Ç–æ–∞–ª—å–±–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º! ID: {result}")
            return result

        except Exception as e:
            logger.error(f"VK: –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º–∞: {e}")
            await self.send_message(user_id, text, keyboard)

    async def upload_photo(self, photo_url: str):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ –ø–æ URL –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç attachment —Å—Ç—Ä–æ–∫—É –¥–ª—è VK"""
        try:
            logger.info(f"VK: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∏–∑ URL: {photo_url}")

            # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
            response = requests.get(photo_url, timeout=10)
            response.raise_for_status()

            # –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            upload_url = self.vk.photos.getMessagesUploadServer()['upload_url']

            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä VK
            files = {'photo': ('photo.jpg', response.content, 'image/jpeg')}
            upload_response = requests.post(upload_url, files=files, timeout=10)
            upload_response.raise_for_status()
            upload_data = upload_response.json()

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ
            save_response = self.vk.photos.saveMessagesPhoto(
                server=upload_data['server'],
                photo=upload_data['photo'],
                hash=upload_data['hash']
            )

            if save_response:
                photo = save_response[0]
                attachment = f"photo{photo['owner_id']}_{photo['id']}"
                logger.info(f"VK: –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {attachment}")
                return attachment
            else:
                logger.error("VK: –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ")
                return None

        except Exception as e:
            logger.error(f"VK: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: {e}")
            return None

    async def process_callback(self, user_id: int, command: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–æ–º–∞–Ω–¥—ã"""
        try:
            logger.info(f"VK: –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–æ–º–∞–Ω–¥—ã: \'{command}\'")
            # –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ 3 –∞—Ä–≥—É–º–µ–Ω—Ç–∞, message_id –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è VK
            await self.bot_core.handle_callback(Platform.VK, user_id, command)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ process_callback: {e}")
            import traceback
            logger.error(f"–î–µ—Ç–∞–ª–∏: {traceback.format_exc()}")

    async def send_message(self, user_id: int, text: str, keyboard=None):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        try:
            logger.info(f"VK: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
            logger.info(f"VK: –¢–µ–∫—Å—Ç: {text}")

            params = {
                "user_id": user_id,
                "message": text,
                "random_id": get_random_id(),
                "dont_parse_links": 1
            }

            if keyboard:
                logger.info("VK: –î–æ–±–∞–≤–ª—è—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É")
                params["keyboard"] = keyboard

                # –õ–æ–≥–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                try:
                    if isinstance(keyboard, str):
                        keyboard_obj = json.loads(keyboard)
                    else:
                        keyboard_obj = keyboard
                    logger.info(
                        f"VK: –ö–Ω–æ–ø–∫–∏: {[btn['action']['label'] for row in keyboard_obj['buttons'] for btn in row]}")
                except Exception as e:
                    logger.error(f"VK: –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: {e}")

            result = self.vk.messages.send(**params)
            logger.info(f"VK: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! ID: {result}")
            return result

        except Exception as e:
            logger.error(f"VK: –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            import traceback
            logger.error(f"VK: –î–µ—Ç–∞–ª–∏: {traceback.format_exc()}")

    async def edit_message(self, user_id: int, message_id: int, text: str, keyboard=None):
        """–í VK —á–µ—Ä–µ–∑ Long Poll –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ"""
        await self.send_message(user_id, text, keyboard)


# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    logger.info("–ó–∞–ø—É—Å–∫ –º—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞...")

    bot_core = FurnitureBotCore()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–æ–≤
    telegram_adapter = TelegramAdapter(TELEGRAM_TOKEN, bot_core)
    vk_adapter = VKAdapter(VK_TOKEN, VK_GROUP_ID, bot_core)

    bot_core.register_adapter(Platform.TELEGRAM, telegram_adapter)
    bot_core.register_adapter(Platform.VK, vk_adapter)

    # –ó–∞–ø—É—Å–∫–∞–µ–º VK –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    def run_vk():
        vk_adapter.run()

    vk_thread = threading.Thread(target=run_vk, daemon=True)
    vk_thread.start()

    logger.info("VK: —Ä–∞–±–æ—Ç–∞–µ—Ç")
    logger.info("Telegram: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ")

    # –ó–∞–ø—É—Å–∫ Telegram –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    telegram_adapter.run()

    logger.info("–û–±–∞ –±–æ—Ç–∞ –∑–∞–ø—É—â–µ–Ω—ã! –ù–∞–∂–º–∏ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")

    try:
        # –î–µ—Ä–∂–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã–º
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        logger.info("\n–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–æ–≤...")


if __name__ == '__main__':
    main()
